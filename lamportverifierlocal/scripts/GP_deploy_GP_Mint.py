import lorem

import sys
from itertools import chain
import random
import hashlib
import base64
from web3 import Web3
from web3.exceptions import InvalidAddress
from brownie import network, web3, accounts, Wei, AnonIDContract, Contract
from brownie.network import gas_price
from brownie.network.gas.strategies import LinearScalingStrategy
from eth_utils import encode_hex #, encode_single
from eth_abi import encode_single, encode_abi
from Crypto.Hash import keccak
from typing import List
import json
import os
import ast
import time
from time import sleep
import re
from typing import List
import struct
from offchain.local_functions import get_pkh_list
from offchain.KeyTracker_ import KeyTracker
from offchain.soliditypack import solidity_pack_value_bytes, solidity_pack_value, pack_keys, encode_packed_2d_list, solidity_pack_bytes, encode_packed, solidity_pack_pairs, solidity_pack, solidity_pack_bytes, solidity_pack_array
from offchain.Types import LamportKeyPair, Sig, PubPair
from offchain.functions import hash_b, sign_hash, verify_signed_hash
from eth_abi import encode_abi, encode_single
from binascii import crc32, hexlify
import binascii
from offchain.crc import compute_crc
#from offchain.oracle_functions import extract_data_from_file, get_pkh_list, send_pkh_with_crc, save_received_data, read_till_eof, send_packed_file
import offchain.data_temp

SOF = b'\x01'  # Start Of File marker
EOF = b'\x04'  # End Of File marker
CRC_START = b'<CRC>'
CRC_END = b'</CRC>'



gas_strategy = LinearScalingStrategy("120 gwei", "1200 gwei", 1.1)

# if network.show_active() == "development":
gas_price(gas_strategy)

# ITERATIONS = 3

# def compute_crc(self, data: str) -> int:
#     return crc32(data.encode())

offchain.data_temp.received_data = b''

def encode_packed(*args):
    return b"".join([struct.pack(f"<{len(arg)}s", arg) for arg in args])


def custom_encode_packed(address, integer):
    # Convert the address to bytes and pad with zeroes
    address_bytes = bytes(Web3.toBytes(hexstr=address))

    # Convert the integer to bytes and pad with zeroes
    integer_bytes = encode_single('uint', integer)

    # Concatenate everything together
    result = address_bytes + b'\0' * 12 + integer_bytes + b'\0' * 12

    return result.decode('unicode_escape')

def main():
    for _ in range(1):  # This will repeat the whole logic 3 times
        lamport_test = LamportTest()
        
        # Convert all account objects to strings before passing them
        lamport_test.can_test_key_functions([str(acc) for acc in accounts])


oracle_pkh = []
master_pkh_1 = []
master_pkh_2 = []
master_pkh_3 = []
arg1 = "GPGrens"
arg2 = "GPG"

# ABI encode the arguments
encoded_args = encode_abi(['string', 'string'], [arg1, arg2])

# Load the bytecode of the contract (replace with actual bytecode)
full_bytecode = "0x608060405234801561001057600080fd5b50614734806100206000396000f3fe608060405234801561001057600080fd5b50600436106102a05760003560e01c8063753ac6dc11610167578063ae61d2c2116100ce578063c8dab0dd11610087578063c8dab0dd146106a1578063d47b2e99146106b4578063d83c413c146106c7578063e673d71f146106da578063f82e84fd146106ed578063fb632d891461070057600080fd5b8063ae61d2c214610611578063af82f3e714610624578063b889b2b714610637578063b97b4f7714610640578063ba69067714610660578063c506f2331461068057600080fd5b80638eb8f1a6116101205780638eb8f1a6146105775780638fd5e0cc1461058a578063931742d31461059d57806397688a0d146105ae5780639b19251a146105c1578063a9711ee3146105e457600080fd5b8063753ac6dc146104e2578063787325ca1461050d5780637e08deae146105365780638705d945146105495780638775b01f146105515780638ab1d6811461056457600080fd5b80634a6728701161020b5780635961f500116101c45780635961f500146104445780635a725b07146104575780635c16e15e1461047c5780636118b1c31461049c5780636ab987c5146104af5780636c8dd0bd146104c257600080fd5b80634a672870146103cf5780634bdd4499146103e25780634e657d2a146103eb5780634fbbc63f146103fe5780635360aa971461041e5780635796841a1461043157600080fd5b80632eb4b54f1161025d5780632eb4b54f146103505780632fd5c247146103635780633337db52146103705780633af32abf146103875780633e13566b146103b357806340f1df15146103bc57600080fd5b806303545eac146102a557806305423224146102dd57806305aacc7d146102f25780630cb6aaf114610314578063142eb8c8146103355780631a533daa1461033d575b600080fd5b6102c86102b3366004613cf8565b60096020526000908152604090205460ff1681565b60405190151581526020015b60405180910390f35b6102f06102eb366004613d37565b610720565b005b610305610300366004613da3565b610913565b6040516102d493929190613df4565b610327610322366004613da3565b610a0c565b6040516102d4929190613e13565b6102f0610a3e565b6102f061034b366004613ed9565b610b7a565b6102f061035e366004613ed9565b610ca7565b600b546102c89060ff1681565b61037960155481565b6040519081526020016102d4565b6102c8610395366004613cf8565b6001600160a01b03166000908152600a602052604090205460ff1690565b61037960145481565b6103796103ca366004613cf8565b610d60565b6102f06103dd366004613f26565b610e73565b61037960035481565b6102f06103f9366004613f88565b610fec565b61037961040c366004613cf8565b600e6020526000908152604090205481565b6102f061042c366004613f26565b611163565b6102f061043f366004613f26565b6112dc565b6102f0610452366004613d37565b61151b565b61046a61046536600461401e565b611778565b60405160ff90911681526020016102d4565b61037961048a366004613cf8565b600d6020526000908152604090205481565b6102f06104aa36600461406b565b611930565b6102f06104bd366004614095565b611a69565b6103796104d0366004613cf8565b600c6020526000908152604090205481565b6104f56104f0366004613f88565b611c1a565b6040516001600160a01b0390911681526020016102d4565b61037961051b366004613cf8565b6001600160a01b03166000908152600c602052604090205490565b6102f0610544366004613f26565b611e69565b601554610379565b6102c861055f366004613cf8565b612116565b6102f0610572366004613cf8565b61231f565b6102f06105853660046140ef565b61240c565b6102f0610598366004614095565b61258b565b6016546001600160a01b03166104f5565b6102f06105bc366004613d37565b612759565b6102c86105cf366004613cf8565b600a6020526000908152604090205460ff1681565b6103276105f2366004613da3565b6001602081905260009182526040909120805491015460ff9091169082565b6102f061061f366004613d37565b6128eb565b6102c8610632366004614152565b612a89565b61037960135481565b61065361064e3660046141aa565b612b3e565b6040516102d491906141cb565b61037961066e366004613cf8565b600f6020526000908152604090205481565b61069361068e366004613cf8565b612ceb565b6040516102d492919061425f565b6102f06106af366004614095565b612d8f565b6102f06106c236600461406b565b612f60565b6102f06106d5366004613f26565b613036565b6102f06106e8366004613f26565b6131b4565b6102f06106fb366004613f88565b6136d3565b61037961070e366004613cf8565b60076020526000908152604090205481565b838383836040516020016107349190614281565b604051602081830303815290604052600084604051602001610756919061429e565b60408051601f19818403018152919052805160209091012090506000808281526001602052604090205460ff16600281111561079457610794613dbc565b146107ba5760405162461bcd60e51b81526004016107b1906142d5565b60405180910390fd5b600082846040516020016107cf92919061430a565b60408051601f1981840301815290829052805160209182012080835292506000805160206146bf833981519152910160405180910390a16000610813828789612a89565b600b805460ff191682151517905590508061089e5760405182815260008051602061469f833981519152906020015b60405180910390a160405162461bcd60e51b815260206004820152602360248201527f416e6f6e4944436f6e74726163743a20566572696669636174696f6e206661696044820152621b195960ea1b60648201526084016107b1565b600083815260016020526040908190205490516000805160206146df833981519152916108d49160ff9091169086908990613df4565b60405180910390a16108e68386613852565b5050601180546001600160a01b0319166001600160a01b0397909716969096179095555050505050505050565b60008181526001602052604080822081518083019092528054839283928392829060ff16600281111561094857610948613dbc565b600281111561095957610959613dbc565b81526001919091015460209182015281015190915060000361098d5760405162461bcd60e51b81526004016107b19061432c565b60005b6000548110156109ec5785600082815481106109ae576109ae614363565b906000526020600020906002020160010154036109da5781516020909201519194509092509050610a05565b806109e48161438f565b915050610990565b5060405162461bcd60e51b81526004016107b19061432c565b9193909250565b60008181548110610a1c57600080fd5b60009182526020909120600290910201805460019091015460ff909116915082565b336000818152600a602052604090205460ff16610a9d5760405162461bcd60e51b815260206004820152601760248201527f55736572206973206e6f742077686974656c697374656400000000000000000060448201526064016107b1565b6001600160a01b0381166000908152600d6020908152604080832054600e9092529091205480821015610b095760405162461bcd60e51b8152602060048201526014602482015273496e76616c696420636c61696d2076616c75657360601b60448201526064016107b1565b6001600160a01b0383166000818152600e60209081526040808320869055600c80835281842054600d84529382902084905582528051868152918201929092527fdc5ec23a202853e756bbb0c4f4cb94deea4936fcc71756da3ddebf99aabf6c9e91015b60405180910390a2505050565b3360009081526009602052604090205460ff16610ba95760405162461bcd60e51b81526004016107b1906143a8565b600081604051602001610bbc91906143e9565b60408051601f1981840301815291815281516020928301206001600160a01b0386166000908152600a90935291205490915060ff1615610c3e5760405162461bcd60e51b815260206004820152601b60248201527f4164647265737320616c72656164792077686974656c6973746564000000000060448201526064016107b1565b6001600160a01b038316600081815260076020908152604080832060059055600a8252808320805460ff19166001179055600f82529182902084905590518381527fc27d38ad1bdb4164d72e05492b5ce6099b4169e9f20b41d3c7cf35c114a64d5b9101610b6d565b3360009081526009602052604090205460ff16610d125760405162461bcd60e51b815260206004820152602360248201527f4e6f74207065726d697474656420746f20757064617465206c61737420706c616044820152621e595960ea1b60648201526084016107b1565b604080518082018252828152426020808301919091526001600160a01b038516600090815260089091529190912081518190610d4e908261448e565b50602082015181600101559050505050565b6001600160a01b0381166000908152600a602052604081205460ff16610d8857506000919050565b6001600160a01b03821660009081526007602090815260408083205460058352818420600690935292206001820154831115610dd6576001820154610dcd908461454d565b95945050505050565b8154610e1082826101f48110610dee57610dee614363565b0154610dfa904261454d565b1115610e0a575091949350505050565b82546000908590610e1c906001614560565b610e269190614573565b9050610e1083826101f48110610e3e57610e3e614363565b0154610e4a904261454d565b1115610e6657610e5b60018661454d565b979650505050505050565b5060009695505050505050565b83838383604051602001610e8991815260200190565b604051602081830303815290604052600084604051602001610eab919061429e565b60408051601f19818403018152919052805160209091012090506000808281526001602052604090205460ff166002811115610ee957610ee9613dbc565b14610f065760405162461bcd60e51b81526004016107b1906142d5565b60008284604051602001610f1b92919061430a565b60408051601f1981840301815290829052805160209182012080835292506000805160206146bf833981519152910160405180910390a16000610f5f828789612a89565b600b805460ff1916821515179055905080610f925760405182815260008051602061469f83398151915290602001610842565b600083815260016020526040908190205490516000805160206146df83398151915291610fc89160ff9091169086908990613df4565b60405180910390a1610fda8386613852565b50505060179490945550505050505050565b8383838360405160200161100091906143e9565b604051602081830303815290604052600084604051602001611022919061429e565b60408051601f19818403018152919052805160209091012090506000808281526001602052604090205460ff16600281111561106057611060613dbc565b1461107d5760405162461bcd60e51b81526004016107b1906142d5565b6000828460405160200161109292919061430a565b60408051601f1981840301815290829052805160209182012080835292506000805160206146bf833981519152910160405180910390a160006110d6828789612a89565b600b805460ff19168215151790559050806111095760405182815260008051602061469f83398151915290602001610842565b600083815260016020526040908190205490516000805160206146df8339815191529161113f9160ff9091169086908990613df4565b60405180910390a16111518386613852565b50505060039590955550505050505050565b8383838360405160200161117991815260200190565b60405160208183030381529060405260008460405160200161119b919061429e565b60408051601f19818403018152919052805160209091012090506000808281526001602052604090205460ff1660028111156111d9576111d9613dbc565b146111f65760405162461bcd60e51b81526004016107b1906142d5565b6000828460405160200161120b92919061430a565b60408051601f1981840301815290829052805160209182012080835292506000805160206146bf833981519152910160405180910390a1600061124f828789612a89565b600b805460ff19168215151790559050806112825760405182815260008051602061469f83398151915290602001610842565b600083815260016020526040908190205490516000805160206146df833981519152916112b89160ff9091169086908990613df4565b60405180910390a16112ca8386613852565b50505060109490945550505050505050565b838383836040516020016112f291815260200190565b604051602081830303815290604052600084604051602001611314919061429e565b60408051601f19818403018152919052805160209091012090506000808281526001602052604090205460ff16600281111561135257611352613dbc565b1461136f5760405162461bcd60e51b81526004016107b1906142d5565b6000828460405160200161138492919061430a565b60408051601f1981840301815290829052805160209182012080835292506000805160206146bf833981519152910160405180910390a160006113c8828789612a89565b600b805460ff19168215151790559050806113fb5760405182815260008051602061469f83398151915290602001610842565b600083815260016020526040908190205490516000805160206146df833981519152916114319160ff9091169086908990613df4565b60405180910390a16114438386613852565b60008b604051602001611456919061429e565b60408051601f198184030181529190528051602090910120600380546000909155909150811415806114fc5760405162461bcd60e51b815260206004820152604360248201527f416e6f6e4944436f6e74726163743a20504b48206d617463686573206c61737460448201527f207573656420504b482028757365207365706172617465207365636f6e64206b60648201526265792960e81b608482015260a4016107b1565b61150760008b6139f5565b505060006003555050505050505050505050565b8383838360405160200161152f9190614281565b604051602081830303815290604052600084604051602001611551919061429e565b60408051601f19818403018152919052805160209091012090506000808281526001602052604090205460ff16600281111561158f5761158f613dbc565b146115ac5760405162461bcd60e51b81526004016107b1906142d5565b600082846040516020016115c192919061430a565b60408051601f1981840301815290829052805160209182012080835292506000805160206146bf833981519152910160405180910390a16000611605828789612a89565b600b805460ff19168215151790559050806116385760405182815260008051602061469f83398151915290602001610842565b600083815260016020526040908190205490516000805160206146df8339815191529161166e9160ff9091169086908990613df4565b60405180910390a16116808386613852565b876040516020016116919190614281565b604051602081830303815290604052805190602001206018541461171f576040805162461bcd60e51b81526020600482015260248101919091527f416e6f6e4944436f6e74726163743a204d69736d61746368656420616464726560448201527f73732068617368206265747765656e2073746570206f6e6520616e642074776f60648201526084016107b1565b601680546001600160a01b0319166001600160a01b038a16908117909155600060188190556040517f78cb7d38f54b570d3aa94edfe9942ff10d8b002a73299229ea4ece39479eb1169190a25050505050505050505050565b6001600160a01b0381166000908152600860205260408082208151808301909252805483929190829082906117ac90614405565b80601f01602080910402602001604051908101604052809291908181526020018280546117d890614405565b80156118255780601f106117fa57610100808354040283529160200191611825565b820191906000526020600020905b81548152906001019060200180831161180857829003601f168201915b50505050508152602001600182015481525050905060006101e082602001514261184f919061454d565b1090508080156118aa57508460405160200161186b91906143e9565b60408051601f198184030181529082905280516020918201208451909261189292016143e9565b60405160208183030381529060405280519060200120145b156118ba5760029250505061192a565b8080156119135750846040516020016118d391906143e9565b60408051601f19818403018152908290528051602091820120845190926118fa92016143e9565b6040516020818303038152906040528051906020012014155b156119235760019250505061192a565b6000925050505b92915050565b3360009081526009602052604090205460ff166119a85760405162461bcd60e51b815260206004820152603060248201527f4e6f74207065726d697474656420746f206d6f6469667920686f75726c79207460448201526f72616e73616374696f6e2071756f746160801b60648201526084016107b1565b6001600160a01b0382166000908152600a602052604090205460ff16611a105760405162461bcd60e51b815260206004820152601e60248201527f41646472657373206e6f7420666f756e6420696e2077686974656c697374000060448201526064016107b1565b6001600160a01b03821660008181526007602052604090819020839055517f49e4e7ca63dcc35a72589f844cb844ce25176e8e1aff16f1ad1fb46624c6537290611a5d9084815260200190565b60405180910390a25050565b828282601054604051602001611a8191815260200190565b604051602081830303815290604052600084604051602001611aa3919061429e565b60408051601f19818403018152919052805160209091012090506000808281526001602052604090205460ff166002811115611ae157611ae1613dbc565b14611afe5760405162461bcd60e51b81526004016107b1906142d5565b60008284604051602001611b1392919061430a565b60408051601f1981840301815290829052805160209182012080835292506000805160206146bf833981519152910160405180910390a16000611b57828789612a89565b600b805460ff1916821515179055905080611b8a5760405182815260008051602061469f83398151915290602001610842565b600083815260016020526040908190205490516000805160206146df83398151915291611bc09160ff9091169086908990613df4565b60405180910390a1611bd28386613852565b60105460138190556040519081527f58098eeec115cba633a1b8765151f8a2e4efbdcb42846e0968e430d56e21d370906020015b60405180910390a150505050505050505050565b600084848484604051602001611c3091906143e9565b604051602081830303815290604052600084604051602001611c52919061429e565b60408051601f19818403018152919052805160209091012090506000808281526001602052604090205460ff166002811115611c9057611c90613dbc565b14611cad5760405162461bcd60e51b81526004016107b1906142d5565b60008284604051602001611cc292919061430a565b60408051601f1981840301815290829052805160209182012080835292506000805160206146bf833981519152910160405180910390a16000611d06828789612a89565b600b805460ff1916821515179055905080611d395760405182815260008051602061469f83398151915290602001610842565b600083815260016020526040908190205490516000805160206146df83398151915291611d6f9160ff9091169086908990613df4565b60405180910390a1611d818386613852565b601454895160208b012014611df65760405162461bcd60e51b815260206004820152603560248201527f42797465636f646520646f6573206e6f74206d617463682070726576696f7573604482015274363c90383937bb34b232b210313cba32b1b7b2329760591b60648201526084016107b1565b6000895160208b016000f090506001600160a01b038116611e595760405162461bcd60e51b815260206004820152601860248201527f436f6e7472616374206372656174696f6e206661696c6564000000000000000060448201526064016107b1565b9c9b505050505050505050505050565b83838383604051602001611e7f91815260200190565b604051602081830303815290604052600084604051602001611ea1919061429e565b60408051601f19818403018152919052805160209091012090506000808281526001602052604090205460ff166002811115611edf57611edf613dbc565b14611efc5760405162461bcd60e51b81526004016107b1906142d5565b60008284604051602001611f1192919061430a565b60408051601f1981840301815290829052805160209182012080835292506000805160206146bf833981519152910160405180910390a16000611f55828789612a89565b600b805460ff1916821515179055905080611f885760405182815260008051602061469f83398151915290602001610842565b600083815260016020526040908190205490516000805160206146df83398151915291611fbe9160ff9091169086908990613df4565b60405180910390a1611fd08386613852565b60148811156120475760405162461bcd60e51b815260206004820152603760248201527f416e6f6e4944436f6e74726163743a20436f6d6d697373696f6e2073686f756c60448201527f64206265206265747765656e20302520616e642032302500000000000000000060648201526084016107b1565b60175488146120cc5760405162461bcd60e51b815260206004820152604560248201527f416e6f6e4944436f6e74726163743a204d69736d61746368656420636f6d6d6960448201527f7373696f6e2076616c756573206265747765656e2073746570206f6e6520616e606482015264642074776f60d81b608482015260a4016107b1565b601588905560006017556040518881527f11bf320227562bd5f6c9b575913cf92b3b996b47873159df227324ae1bb4d0ea9060200160405180910390a15050505050505050505050565b600033732685751d3c7a49ebf485e823079ac65e2a35a3dd81149061213a90613afa565b60405160200161214a9190614595565b604051602081830303815290604052906121775760405162461bcd60e51b81526004016107b191906145f0565b506001600160a01b0382166000908152600a602052604090205460ff166121a057506000919050565b6001600160a01b03821660009081526007602052604081205490036121c757506000919050565b6001600160a01b0382166000908152600560209081526040808320600683528184206007909352922054600183015410612267578154610e1082826101f4811061221357612213614363565b015461221f904261454d565b1161222f57506000949350505050565b6001600160a01b0385166000908152600760205260409020548354612255906001614560565b61225f9190614573565b83555061227f565b6001820180549060006122798361438f565b91905055505b6001600160a01b03841660009081526007602052604081205460018481015485546122aa9190614560565b6122b4919061454d565b6122be9190614573565b90504282826101f481106122d4576122d4614363565b01556040514281526001600160a01b038616907f9ed0861f8fc182c8888f48e900842f475ccd2a3c93c6f966168eaa67d52d2ee19060200160405180910390a2506001949350505050565b3360009081526009602052604090205460ff1661234e5760405162461bcd60e51b81526004016107b1906143a8565b6001600160a01b0381166000908152600a602052604090205460ff166123b65760405162461bcd60e51b815260206004820152601e60248201527f41646472657373206e6f7420666f756e6420696e2077686974656c697374000060448201526064016107b1565b6001600160a01b0381166000818152600a60209081526040808320805460ff19169055600f909152808220829055517fcdd2e9b91a56913d370075169cefa1602ba36be5301664f752192bb1709df7579190a250565b8382848360405160200161242291815260200190565b604051602081830303815290604052600084604051602001612444919061429e565b60408051601f19818403018152919052805160209091012090506000808281526001602052604090205460ff16600281111561248257612482613dbc565b1461249f5760405162461bcd60e51b81526004016107b1906142d5565b600082846040516020016124b492919061430a565b60408051601f1981840301815290829052805160209182012080835292506000805160206146bf833981519152910160405180910390a160006124f8828789612a89565b600b805460ff191682151517905590508061252b5760405182815260008051602061469f83398151915290602001610842565b600083815260016020526040908190205490516000805160206146df833981519152916125619160ff9091169086908990613df4565b60405180910390a16125738386613852565b61257e6001896139f5565b5050505050505050505050565b6012546040518491849184916125af916001600160a01b0390911690602001614281565b6040516020818303038152906040526000846040516020016125d1919061429e565b60408051601f19818403018152919052805160209091012090506000808281526001602052604090205460ff16600281111561260f5761260f613dbc565b1461262c5760405162461bcd60e51b81526004016107b1906142d5565b6000828460405160200161264192919061430a565b60408051601f1981840301815290829052805160209182012080835292506000805160206146bf833981519152910160405180910390a16000612685828789612a89565b600b805460ff19168215151790559050806126b85760405182815260008051602061469f83398151915290602001610842565b600083815260016020526040908190205490516000805160206146df833981519152916126ee9160ff9091169086908990613df4565b60405180910390a16127008386613852565b601280546001600160a01b03908116600090815260096020908152604091829020805460ff1916905592549051911681527f6c643a308c2943f8cabf6ea94d2fc3741e4995caa21bd8e305b91f06abf14b589101611c06565b8383838360405160200161276d9190614281565b60405160208183030381529060405260008460405160200161278f919061429e565b60408051601f19818403018152919052805160209091012090506000808281526001602052604090205460ff1660028111156127cd576127cd613dbc565b146127ea5760405162461bcd60e51b81526004016107b1906142d5565b600082846040516020016127ff92919061430a565b60408051601f1981840301815290829052805160209182012080835292506000805160206146bf833981519152910160405180910390a16000612843828789612a89565b600b805460ff19168215151790559050806128765760405182815260008051602061469f83398151915290602001610842565b600083815260016020526040908190205490516000805160206146df833981519152916128ac9160ff9091169086908990613df4565b60405180910390a16128be8386613852565b5050601280546001600160a01b0319166001600160a01b0397909716969096179095555050505050505050565b838383836040516020016128ff9190614281565b604051602081830303815290604052600084604051602001612921919061429e565b60408051601f19818403018152919052805160209091012090506000808281526001602052604090205460ff16600281111561295f5761295f613dbc565b1461297c5760405162461bcd60e51b81526004016107b1906142d5565b6000828460405160200161299192919061430a565b60408051601f1981840301815290829052805160209182012080835292506000805160206146bf833981519152910160405180910390a160006129d5828789612a89565b600b805460ff1916821515179055905080612a085760405182815260008051602061469f83398151915290602001610842565b600083815260016020526040908190205490516000805160206146df83398151915291612a3e9160ff9091169086908990613df4565b60405180910390a1612a508386613852565b87604051602001612a619190614281565b60408051601f1981840301815291905280516020909101206018555050505050505050505050565b6000805b610100811015612b315783816101008110612aaa57612aaa614363565b602002810190612aba9190614603565b604051612ac8929190614650565b604051809103902083826101008110612ae357612ae3614363565b6040020160008360ff036001901b881611612aff576000612b02565b60015b60ff1660028110612b1557612b15614363565b602002013514612b29576000915050612b37565b600101612a8d565b50600190505b9392505050565b60008054606091906001600160401b03811115612b5d57612b5d613e2e565b604051908082528060200260200182016040528015612b86578160200160208202803683370190505b5090506000805b600054811015612c4757846002811115612ba957612ba9613dbc565b60008281548110612bbc57612bbc614363565b600091825260209091206002918202015460ff1690811115612be057612be0613dbc565b03612c355760008181548110612bf857612bf8614363565b906000526020600020906002020160010154838381518110612c1c57612c1c614363565b602090810291909101015281612c318161438f565b9250505b80612c3f8161438f565b915050612b8d565b506000816001600160401b03811115612c6257612c62613e2e565b604051908082528060200260200182016040528015612c8b578160200160208202803683370190505b50905060005b82811015612ce257838181518110612cab57612cab614363565b6020026020010151828281518110612cc557612cc5614363565b602090810291909101015280612cda8161438f565b915050612c91565b50949350505050565b600860205260009081526040902080548190612d0690614405565b80601f0160208091040260200160405190810160405280929190818152602001828054612d3290614405565b8015612d7f5780601f10612d5457610100808354040283529160200191612d7f565b820191906000526020600020905b815481529060010190602001808311612d6257829003601f168201915b5050505050908060010154905082565b601154604051849184918491612db3916001600160a01b0390911690602001614281565b604051602081830303815290604052600084604051602001612dd5919061429e565b60408051601f19818403018152919052805160209091012090506000808281526001602052604090205460ff166002811115612e1357612e13613dbc565b14612e305760405162461bcd60e51b81526004016107b1906142d5565b60008284604051602001612e4592919061430a565b60408051601f1981840301815290829052805160209182012080835292506000805160206146bf833981519152910160405180910390a16000612e89828789612a89565b600b805460ff1916821515179055905080612ebc5760405182815260008051602061469f83398151915290602001610842565b600083815260016020526040908190205490516000805160206146df83398151915291612ef29160ff9091169086908990613df4565b60405180910390a1612f048386613852565b601180546001600160a01b03908116600090815260096020908152604091829020805460ff1916600117905592549051911681527f9c2d3039f3d15023b5382d61054aae8f70288e4bffb8676398baca3c389e8f189101611c06565b3360009081526009602052604090205460ff16612fce5760405162461bcd60e51b815260206004820152602660248201527f4e6f74207065726d697474656420746f206d6f64696679206d696e75746573206044820152651c1b185e595960d21b60648201526084016107b1565b6001600160a01b0382166000908152600c602052604081208054839290612ff6908490614560565b90915550506040518181526001600160a01b038316907f54ecab596bd73e6a3fd6d8bb310aa69a74c3f78ddc040f88c6f5d06dffb3542b90602001611a5d565b8383838360405160200161304c91815260200190565b60405160208183030381529060405260008460405160200161306e919061429e565b60408051601f19818403018152919052805160209091012090506000808281526001602052604090205460ff1660028111156130ac576130ac613dbc565b146130c95760405162461bcd60e51b81526004016107b1906142d5565b600082846040516020016130de92919061430a565b60408051601f1981840301815290829052805160209182012080835292506000805160206146bf833981519152910160405180910390a16000613122828789612a89565b600b805460ff19168215151790559050806131555760405182815260008051602061469f83398151915290602001610842565b600083815260016020526040908190205490516000805160206146df8339815191529161318b9160ff9091169086908990613df4565b60405180910390a161319d8386613852565b505050600494909455505050600291909155505050565b838383836040516020016131ca91815260200190565b6040516020818303038152906040526000846040516020016131ec919061429e565b60408051601f19818403018152919052805160209091012090506000808281526001602052604090205460ff16600281111561322a5761322a613dbc565b146132475760405162461bcd60e51b81526004016107b1906142d5565b6000828460405160200161325c92919061430a565b60408051601f1981840301815290829052805160209182012080835292506000805160206146bf833981519152910160405180910390a160006132a0828789612a89565b600b805460ff19168215151790559050806132d35760405182815260008051602061469f83398151915290602001610842565b600083815260016020526040908190205490516000805160206146df833981519152916133099160ff9091169086908990613df4565b60405180910390a161331b8386613852565b60008b60405160200161332e919061429e565b60405160208183030381529060405280519060200120905060025481036133cb5760405162461bcd60e51b8152602060048201526044602482018190527f416e6f6e4944436f6e74726163743a2043616e6e6f7420757365207468652073908201527f616d65206b6579636861696e20747769636520666f7220746869732066756e636064820152633a34b7b760e11b608482015260a4016107b1565b88600454146134265760405162461bcd60e51b815260206004820152602160248201527f416e6f6e4944436f6e74726163743a204b65797320646f206e6f74206d6174636044820152600d60fb1b60648201526084016107b1565b600254818a6000808481526001602052604090205460ff16600281111561344f5761344f613dbc565b14801561347c575060008281526001602052604081205460ff16600281111561347a5761347a613dbc565b145b6134e25760405162461bcd60e51b815260206004820152603160248201527f416e6f6e4944436f6e74726163743a2050726f7669646564206b65797320617260448201527065206e6f74206d6173746572206b65797360781b60648201526084016107b1565b8281141580156134f25750818114155b61355b5760405162461bcd60e51b815260206004820152603460248201527f416e6f6e4944436f6e74726163743a204d6173746572206b6579732063616e6e6044820152736f742064656c657465207468656d73656c76657360601b60648201526084016107b1565b60008181526001602081905260408220015490036135ca5760405162461bcd60e51b815260206004820152602660248201527f416e6f6e4944436f6e74726163743a204e6f2073756368206b6579202864656c6044820152656574696f6e2960d01b60648201526084016107b1565b60005b6000548110156136b75781600082815481106135eb576135eb614363565b906000526020600020906002020160010154036136a557600082815260016020818152604080842080548251428186015244818501528351808203850181526060909101938490528051908501209588905292849052630de1e7ed60e41b8518938101849055600260ff198416811790915560ff90921693917f0643be3612916977c69d5ed1abb75a50cca49df49ba2444d836e2a0cf65fe0749161369591869189918791614660565b60405180910390a15050506136b7565b806136af8161438f565b9150506135cd565b5050600060048190556002555050505050505050505050505050565b838383836040516020016136e791906143e9565b604051602081830303815290604052600084604051602001613709919061429e565b60408051601f19818403018152919052805160209091012090506000808281526001602052604090205460ff16600281111561374757613747613dbc565b146137645760405162461bcd60e51b81526004016107b1906142d5565b6000828460405160200161377992919061430a565b60408051601f1981840301815290829052805160209182012080835292506000805160206146bf833981519152910160405180910390a160006137bd828789612a89565b600b805460ff19168215151790559050806137f05760405182815260008051602061469f83398151915290602001610842565b600083815260016020526040908190205490516000805160206146df833981519152916138269160ff9091169086908990613df4565b60405180910390a16138388386613852565b505085516020909601959095206014555050505050505050565b60008281526001602081905260408220015490036138825760405162461bcd60e51b81526004016107b19061432c565b6040805180820182526000848152600160205291822054819060ff1660028111156138af576138af613dbc565b8152602090810184905260008481526001918290526040902082518154939450849391929091839160ff19909116908360028111156138f0576138f0613dbc565b021790555060209182015160019182015560008581529181905260408220805460ff19168155018190555b6000548110156139c557836000828154811061393957613939614363565b906000526020600020906002020160010154036139b357816000828154811061396457613964614363565b906000526020600020906002020160008201518160000160006101000a81548160ff0219169083600281111561399c5761399c613dbc565b0217905550602082015181600101559050506139c5565b806139bd8161438f565b91505061391b565b5080516040516000805160206146df833981519152916139e89186908690613df4565b60405180910390a1505050565b60006040518060400160405280846002811115613a1457613a14613dbc565b81526020018390526000805460018181018355918052825160029182027f290decd9548b62a8d60345a988386fc84ba6bc95484008f6362f93160ef3e563018054949550859490939192849260ff1990921691908490811115613a7957613a79613dbc565b02179055506020918201516001918201556000848152918190526040909120825181548493839160ff191690836002811115613ab757613ab7613dbc565b0217905550602082015181600101559050507f2172c7b01a6de957d29fd6166a23025d181bf56538ad606a526ab2d62603f3fc83836040516139e8929190613e13565b604080518082018252601081526f181899199a1a9b1b9c1cb0b131b232b360811b60208201528151602a80825260608281019094526001600160a01b0385169291600091602082018180368337019050509050600360fc1b81600081518110613b6557613b65614363565b60200101906001600160f81b031916908160001a905350600f60fb1b81600181518110613b9457613b94614363565b60200101906001600160f81b031916908160001a90535060005b6014811015612ce25782600485613bc684600c614560565b60208110613bd657613bd6614363565b1a60f81b6001600160f81b031916901c60f81c60ff1681518110613bfc57613bfc614363565b01602001516001600160f81b03191682613c17836002614687565b613c22906002614560565b81518110613c3257613c32614363565b60200101906001600160f81b031916908160001a9053508284613c5683600c614560565b60208110613c6657613c66614363565b825191901a600f16908110613c7d57613c7d614363565b01602001516001600160f81b03191682613c98836002614687565b613ca3906003614560565b81518110613cb357613cb3614363565b60200101906001600160f81b031916908160001a90535080613cd48161438f565b915050613bae565b80356001600160a01b0381168114613cf357600080fd5b919050565b600060208284031215613d0a57600080fd5b612b3782613cdc565b80614000810183101561192a57600080fd5b80612000810183101561192a57600080fd5b6000806000806140608587031215613d4e57600080fd5b613d588686613d13565b93506140008501356001600160401b03811115613d7457600080fd5b613d8087828801613d25565b9350506140208501359150613d986140408601613cdc565b905092959194509250565b600060208284031215613db557600080fd5b5035919050565b634e487b7160e01b600052602160045260246000fd5b60038110613df057634e487b7160e01b600052602160045260246000fd5b9052565b60608101613e028286613dd2565b602082019390935260400152919050565b60408101613e218285613dd2565b8260208301529392505050565b634e487b7160e01b600052604160045260246000fd5b60006001600160401b0380841115613e5e57613e5e613e2e565b604051601f8501601f19908116603f01168101908282118183101715613e8657613e86613e2e565b81604052809350858152868686011115613e9f57600080fd5b858560208301376000602087830101525050509392505050565b600082601f830112613eca57600080fd5b612b3783833560208501613e44565b60008060408385031215613eec57600080fd5b613ef583613cdc565b915060208301356001600160401b03811115613f1057600080fd5b613f1c85828601613eb9565b9150509250929050565b6000806000806140608587031215613f3d57600080fd5b613f478686613d13565b93506140008501356001600160401b03811115613f6357600080fd5b613f6f87828801613d25565b9497949650505050614020830135926140400135919050565b6000806000806140608587031215613f9f57600080fd5b613fa98686613d13565b93506140008501356001600160401b0380821115613fc657600080fd5b613fd288838901613d25565b94506140208701359350614040870135915080821115613ff157600080fd5b508501601f8101871361400357600080fd5b61401287823560208401613e44565b91505092959194509250565b6000806040838503121561403157600080fd5b82356001600160401b0381111561404757600080fd5b61405385828601613eb9565b92505061406260208401613cdc565b90509250929050565b6000806040838503121561407e57600080fd5b61408783613cdc565b946020939093013593505050565b600080600061404084860312156140ab57600080fd5b6140b58585613d13565b92506140008401356001600160401b038111156140d157600080fd5b6140dd86828701613d25565b92505061402084013590509250925092565b600080600080614060858703121561410657600080fd5b6141108686613d13565b935061400085013592506140208501356001600160401b0381111561413457600080fd5b61414087828801613d25565b94979396509394614040013593505050565b6000806000614040848603121561416857600080fd5b8335925060208401356001600160401b0381111561418557600080fd5b61419186828701613d25565b9250506141a18560408601613d13565b90509250925092565b6000602082840312156141bc57600080fd5b813560038110612b3757600080fd5b6020808252825182820181905260009190848201906040850190845b81811015614203578351835292840192918401916001016141e7565b50909695505050505050565b60005b8381101561422a578181015183820152602001614212565b50506000910152565b6000815180845261424b81602086016020860161420f565b601f01601f19169290920160200192915050565b6040815260006142726040830185614233565b90508260208301529392505050565b60609190911b6bffffffffffffffffffffffff1916815260140190565b60008183825b6101008110156142c5576040808385379283019291909101906001016142a4565b5050506140008201905092915050565b6020808252818101527f416e6f6e4944436f6e74726163743a204e6f742061206d6173746572206b6579604082015260600190565b6000835161431c81846020880161420f565b9190910191825250602001919050565b6020808252601b908201527f416e6f6e4944436f6e74726163743a204e6f2073756368206b65790000000000604082015260600190565b634e487b7160e01b600052603260045260246000fd5b634e487b7160e01b600052601160045260246000fd5b6000600182016143a1576143a1614379565b5060010190565b60208082526021908201527f4e6f74207065726d697474656420746f206d6f646966792077686974656c69736040820152601d60fa1b606082015260800190565b600082516143fb81846020870161420f565b9190910192915050565b600181811c9082168061441957607f821691505b60208210810361443957634e487b7160e01b600052602260045260246000fd5b50919050565b601f82111561448957600081815260208120601f850160051c810160208610156144665750805b601f850160051c820191505b8181101561448557828155600101614472565b5050505b505050565b81516001600160401b038111156144a7576144a7613e2e565b6144bb816144b58454614405565b8461443f565b602080601f8311600181146144f057600084156144d85750858301515b600019600386901b1c1916600185901b178555614485565b600085815260208120601f198616915b8281101561451f57888601518255948401946001909101908401614500565b508582101561453d5787850151600019600388901b60f8161c191681555b5050505050600190811b01905550565b8181038181111561192a5761192a614379565b8082018082111561192a5761192a614379565b60008261459057634e487b7160e01b600052601260045260246000fd5b500690565b7f4f6e6c7920546865526f636b2063616e2063616c6c20746869732066756e637481526c034b7b7171021b0b63632b91d1609d1b6020820152600082516145e381602d85016020870161420f565b91909101602d0192915050565b602081526000612b376020830184614233565b6000808335601e1984360301811261461a57600080fd5b8301803591506001600160401b0382111561463457600080fd5b60200191503681900382131561464957600080fd5b9250929050565b8183823760009101908152919050565b6080810161466e8287613dd2565b846020830152836040830152610dcd6060830184613dd2565b808202811582820484141761192a5761192a61437956fe32629d580208e19f97e5752eef849e102f803999c88aa7f75e12b1744eecd5a7d87e68f36f73a7eb22739d6639e36cafebfcde0b5543340b39f42cac68fdd1f06825a39bd161f4ef5aab6cfd2c26db3ee0005c11b43cffd544fc876312116edda2646970667358221220b95b8ffd73ba7053c25edb7b81cf48ed7d030f3d9337db04b3aa3d5bad8447e064736f6c63430008150033"
#print(encoded_args.hex())
# Append the encoded arguments to the bytecode
#print(full_bytecode)
class LamportTest:
    
    def __init__(self):

        self.k1 = KeyTracker("master1") # new keys made here
        self.k2 = KeyTracker("master2")
        self.k3 = KeyTracker("oracle1")
        self.k4 = KeyTracker("master3")
        print("Initializing LamportTest...")
        with open('contract_AnonID.txt', 'r') as file:
            contract_address = file.read().strip()
        #print(contract_address)
        self.contract = AnonIDContract.at(contract_address)
        #lamport_base = LamportBase.at(contract_address) # <<< not working!
        accounts.default = str(accounts[0]) 
        # link it up
        pkhs = self.get_pkh_list(self.contract, 0)
        opkhs = self.get_pkh_list(self.contract, 1)
        # priv level set here with integer ^
        print("contract pkh", pkhs)

        self.load_two_masters(pkhs, "master")
        self.load_keys(opkhs, "oracle")
        print('init done')

    def get_pkh_list(self, contract, privilege_level):
        contract_pkh = str(contract.getPKHsByPrivilege(privilege_level))
        # gonna need some kind of wait / delay here for primetime
        print(contract_pkh)
        contract_pkh_list = re.findall(r'0x[a-fA-F0-9]+', contract_pkh)
        pkh_list = [pkh for pkh in contract_pkh_list]  # Removing '0x' prefix
        contract_pkh_string = json.dumps(contract_pkh)
        contract_pkh_list = json.dumps(contract_pkh_string)
        return pkh_list

    
    def load_two_masters(self, pkhs, filename):
        pkh_index = 0
        master1_loaded = False
        master2_loaded = False
        global master_pkh_1
        global master_pkh_2

        while not master1_loaded and pkh_index < len(pkhs):
            try:
                self.k1.load(self, filename + '1', pkhs[pkh_index])
                print(f"Load successful for Master 1, PKH: {pkhs[pkh_index]}")
                master1_loaded = True
                key_tracker_1 = self.k1.current_key_pair()
                master_pkh_1 = pkhs[pkh_index]
                pkh_index += 1  # increment the pkh_index after successful load
            except InvalidAddress:
                print(f"No valid keys found for Master 1, PKH: {pkhs[pkh_index]}")
                pkh_index += 1  # increment the pkh_index if load failed

        if not master1_loaded:
            print("Load failed for all provided PKHs for Master 1")
            return

        while not master2_loaded and pkh_index < len(pkhs):
            try:
                self.k2.load(self, filename + '2', pkhs[pkh_index])
                print(f"Load successful for Master 2, PKH: {pkhs[pkh_index]}")
                master2_loaded = True
                key_tracker_2 = self.k2.current_key_pair()
                master_pkh_2 = pkhs[pkh_index]
                pkh_index += 1  # increment the pkh_index after successful load
            except InvalidAddress:
                print(f"No valid keys found for Master 2, PKH: {pkhs[pkh_index]}")
                pkh_index += 1  # increment the pkh_index if load failed

        if not master2_loaded:
            print("Load failed for all provided PKHs for Master 2")

    def load_keys(self, pkhs, filename):
        global oracle_pkh
        for pkh in pkhs:
            try:
                oracle_pkh = pkh
                self.k3.load(self, filename + '1', pkh)
                print(f"Load successful for PKH: {pkh}")
                return  # Exit function after successful load
            except InvalidAddress:
                print(f"No valid keys found for PKH: {pkh}")
                continue  # Try the next pkh if this one fails
        print("Load failed for all provided PKHs")

    def can_test_key_functions(self, accs):
        global master_pkh_1
        global master_pkh_2
        #global master_pkh_3
        print("Running 'can_test_key_functions'...")
        with open('contract_AnonID.txt', 'r') as file:
            contract_address = file.read()
            contract_address = contract_address.strip().replace('\n', '')  # Remove whitespace and newlines

        _contract = AnonIDContract.at(contract_address)
        print("Contract referenced.")
        print('master_pkh_1', master_pkh_1)
        private_key = '163f5f0f9a621d72fedd85ffca3d08d131ab4e812181e0d30ffd1c885d20aac7'
        brownie_account = accounts.add(private_key)
        current_keys = self.k1.load(self, "master1", master_pkh_1)
        current_pkh = self.k1.pkh_from_public_key(current_keys.pub)
        print('current pkh', current_pkh)
        next_keys = self.k1.get_next_key_pair()
        nextpkh = self.k1.pkh_from_public_key(next_keys.pub)
        #pairs = generate_address_value_pairs(10)
        #packed_pairs = solidity_pack_pairs(pairs)
        #_newCap = int(300000)
        #numToBroadcast = int(1000000)
        #pnumToBroadcast = numToBroadcast.to_bytes(4, 'big')
        #paddednumToBroadcast = solidity_pack_value_bytes(pnumToBroadcast)
        #paddressToBroadcast = '0x99a840C3BEEe41c3F5B682386f67277CfE3E3e29' # activity contract needing approval
        # with open('whitelist_contract.txt', 'r') as file:
        #     contract_address2 = file.read()
        #     contract_address2 = contract_address2.strip().replace('\n', '') 
        pcontractToBroadcast = Web3.keccak(hexstr=full_bytecode)
        print(pcontractToBroadcast)
        packed_message = str.lower(pcontractToBroadcast)[2:].encode() + nextpkh[2:].encode()
        print(packed_message)
        callhash = hash_b(str(packed_message.decode()))
        sig = sign_hash(callhash, current_keys.pri) 
        private_key = '163f5f0f9a621d72fedd85ffca3d08d131ab4e812181e0d30ffd1c885d20aac7'
        brownie_account = accounts.add(private_key)
        
        _contract.createContractStepOne(
            current_keys.pub,
            sig,
            nextpkh,
            pcontractToBroadcast,
            {'from': brownie_account, 'gas_limit': 3999999}    
        )
        self.k1.save(trim = False)
        #self.k4.save(trim = False)
        master_pkh_1 = nextpkh

        current_keys = self.k2.load(self, "master2", master_pkh_2)
        next_keys = self.k2.get_next_key_pair()
        nextpkh = self.k2.pkh_from_public_key(next_keys.pub)

        #paddressToBroadcast = '0xfd003CA44BbF4E9fB0b2fF1a33fc2F05A6C2EFF9'

        packed_message = str.lower(pcontractToBroadcast)[2:].encode() + nextpkh[2:].encode()

        callhash = hash_b(str(packed_message.decode()))
        sig = sign_hash(callhash, current_keys.pri) 


        
        _contract.createContractStepTwo(
            current_keys.pub,
            sig,
            nextpkh,
            pcontractToBroadcast,
            {'from': brownie_account, 'gas_limit': 3999999}    
        )
        self.k2.save(trim = False)
        exit()